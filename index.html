<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Prototipo Aprendizaje v6 â€” Fluido + Control de Tiempos</title>
<style>
  body {font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#f4f7f6;color:#222;max-width:1000px;margin:18px auto;padding:18px;}
  h1,h2,h3 {color:#005a8d;}
  textarea {width:100%;min-height:140px;padding:10px;font-size:15px;border-radius:6px;border:1px solid #ccc;box-sizing: border-box;}
  button {background:#0073b1;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;margin:4px;}
  button.small {padding:6px 8px;font-size:13px;}
  button.secondary {background:#6c757d;}
  button.success {background:#28a745;}
  button:disabled {opacity: 0.6; cursor: not-allowed;}
  
  .panel {background:white;border:1px solid #e0e0e0;border-radius:8px;padding:12px;margin-top:14px;}
  .ejercicio-frase{font-size:1.05em;margin:10px 0;line-height:1.6;}
  input.input-ej{padding:6px 8px;border-radius:6px;border:1px solid #ccc;font-size:15px;}
  .ok{border-color:#28a745!important;background:#eaffea;}
  .bad{border-color:#dc3545!important;background:#ffeaea;}
  .fragment{border:1px dashed #ddd;padding:10px;margin:8px 0;border-radius:6px;background:#fafafa;}
  .tag{background:#e6f4ff;color:#005a8d;padding:6px 8px;border-radius:999px;border:1px solid #d0eaff;}
  .audio-btn{background:#fff;color:#0073b1;border:1px solid #0073b1;padding:2px 6px;border-radius:4px;cursor:pointer;font-size:0.9em;margin:0 2px;}
  .flexrow{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
  
  /* Estilos del Panel de Control de Pausas */
  .control-panel { background: #fff8e1; border: 1px solid #ffe082; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
  .slider-group { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; font-size: 0.9em; }
  .slider-group input { flex: 1; }

  #notify {position:fixed;bottom:20px;right:20px;background:#005a8d;color:white;padding:10px 14px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.2);opacity:0;transition:opacity 0.4s; z-index: 100;}
  #notify.show{opacity:1;}
</style>
</head>
<body>

<h1>Prototipo v6 (Smart Flow)</h1>

<div class="control-panel">
  <h3>ğŸ›ï¸ Control de Mezcla (Pausas)</h3>
  <div class="slider-group">
    <label>Pausa ANTES de mi voz (ms): <span id="valPre">200</span></label>
    <input type="range" id="pausePre" min="0" max="2000" step="50" value="200" oninput="document.getElementById('valPre').innerText=this.value">
  </div>
  <div class="slider-group">
    <label>Pausa DESPUÃ‰S de mi voz (ms): <span id="valPost">300</span></label>
    <input type="range" id="pausePost" min="0" max="2000" step="50" value="300" oninput="document.getElementById('valPost').innerText=this.value">
  </div>
  <small style="color:#666;">Ajusta cuÃ¡nto silencio quieres antes y despuÃ©s de insertar tus grabaciones en el texto.</small>
</div>

<div class="flexrow">
  <button onclick="procesarTexto()">Procesar Texto</button>
  <label>Idioma:
    <select id="idiomaSelect">
      <option value="en-US" selected>InglÃ©s ğŸ‡ºğŸ‡¸</option>
      <option value="es-ES">EspaÃ±ol ğŸ‡ªğŸ‡¸</option>
      <option value="fr-FR">FrancÃ©s ğŸ‡«ğŸ‡·</option>
      <option value="de-DE">AlemÃ¡n ğŸ‡©ğŸ‡ª</option>
    </select>
  </label>
  <button class="secondary" onclick="limpiarProgreso()">Limpiar todo</button>
</div>

<textarea id="textoUsuario">The quick brown fox jumps over the lazy dog. This is a sentence to test the processing. The dog is lazy, and the fox is quick. Learning a new language is a journey.</textarea>

<div id="resultados" class="panel" style="display:none;">
  <h2>AnÃ¡lisis</h2>
  <div id="metricasTexto"></div>
</div>

<div id="fragmentsContainer" class="panel" style="display:none;">
  <h2>Fragmentos (Lectura Inteligente)</h2>
  <div id="fragments"></div>
</div>

<div id="ejercicios" class="panel" style="display:none;">
  <h2>Ejercicios (GrabaciÃ³n)</h2>
  <div id="listaEjercicios"></div>
</div>

<div id="notify"></div>

<script>
/* === CONSTANTES Y UTILIDADES === */
const STOP_WORDS = new Set(['a','an','and','the','is','it','in','on','at','to','for','of','with','this','that','was','are','be','over','new','makes','s','i','you','he','she','they','we','my','his','her']);
const STORAGE_KEYS={learned:'ap_v6_learned',audios:'ap_v6_audios'};

function cargarEstado(){return{learned:JSON.parse(localStorage.getItem(STORAGE_KEYS.learned)||'[]'),audios:JSON.parse(localStorage.getItem(STORAGE_KEYS.audios)||'{}')}};
function guardarEstado(s){localStorage.setItem(STORAGE_KEYS.learned,JSON.stringify(s.learned||[]));localStorage.setItem(STORAGE_KEYS.audios,JSON.stringify(s.audios||{}));}

function limpiarTexto(t){return t.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()\"\[\]]/g,"").toLowerCase();}
function palabrasTokenize(t){return limpiarTexto(t).split(/\s+/).filter(p=>p.length>0);}
function mostrarNoti(txt,ms=2500){const n=document.getElementById('notify');n.textContent=txt;n.classList.add('show');setTimeout(()=>n.classList.remove('show'),ms);}
function blobToBase64(b){return new Promise((res,rej)=>{const r=new FileReader();r.onloadend=()=>res(r.result);r.onerror=rej;r.readAsDataURL(b);});}
function escaparRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); } // Para evitar errores si la palabra tiene simbolos

let globalFragments=[];
let globalTopWords=[];

/* === PROCESAMIENTO PRINCIPAL === */
function procesarTexto(){
  const t=document.getElementById('textoUsuario').value.trim();if(!t)return mostrarNoti('âš ï¸ Escribe un texto primero.',2000);
  
  // Analisis basico
  const or=t.match(/[^.!?]+[.!?]+/g)||[t];
  const palabras=palabrasTokenize(t);
  const freq={};
  
  for(const p of palabras){
    if(p.length>1 && !STOP_WORDS.has(p)){
        freq[p]=(freq[p]||0)+1;
    }
  }
  
  const top=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,10);
  globalTopWords=top;
  
  document.getElementById('metricasTexto').innerHTML=`Total palabras: <b>${palabras.length}</b> Â· Oraciones: <b>${or.length}</b>`;
  document.getElementById('resultados').style.display='block';
  
  // Dividir en fragmentos (chunks)
  dividirEnFragmentos(t);
  
  generarEjercicios(or,top); 
  renderFragments(); 
  
  document.getElementById('fragmentsContainer').style.display='block';
  document.getElementById('ejercicios').style.display='block';
}

function dividirEnFragmentos(t, maxChars=300){
    let or=t.match(/[^.!?]+[.!?]*/g)||[t];
    or=or.map(s=>s.trim()).filter(s=>s.length>0);
    const frags=[];let cur='';
    for(const s of or){
        if(cur.length+s.length+1<=maxChars||cur.length===0) cur+=(cur?' ':'')+s;
        else{ frags.push(cur.trim()); cur=s; }
    }
    if(cur) frags.push(cur.trim());
    globalFragments = frags;
}

/* === RENDERIZADO VISUAL === */
function renderFragments(){
  const {learned,audios}=cargarEstado();
  const lang=document.getElementById('idiomaSelect').value;
  const c=document.getElementById('fragments');
  c.innerHTML='';
  
  globalFragments.forEach((frag,i)=>{
    // Renderizado visual: resaltar palabras con audio
    let html=frag;
    // Solo reemplazamos visualmente si tenemos el audio
    learned.forEach(w=>{
       if(audios[w]) {
           const r=new RegExp(`\\b(${escaparRegExp(w)})\\b`,'ig');
           html=html.replace(r,`<button class='audio-btn' onclick="playSingleWord('${w}')">ğŸ§ $1</button>`);
       }
    });

    const d=document.createElement('div');d.className='fragment';
    d.innerHTML=`
        <div><b>Fragmento ${i+1}</b></div>
        <div style="margin-top:6px; line-height:1.6;">${html}</div>
        <div class='flexrow' style='margin-top:12px; border-top:1px solid #eee; padding-top:8px;'>
           <button class='small' onclick="leerTextoOriginal('${frag}')">ğŸ—£ï¸ Escuchar Original (TTS)</button>
           <button class='small success' onclick="playSmartMix('${frag}')">âœ¨ Escuchar MEZCLA Inteligente</button>
        </div>`;
    c.appendChild(d);
  });
}

function generarEjercicios(ors,top){
  const l=document.getElementById('listaEjercicios');l.innerHTML='';
  const set=new Set(top.map(p=>p[0]));
  let creados=0;
  
  // Limitar a 10 ejercicios para no saturar
  for(const o of ors){
     if(creados>=10)break;
     for(const w of Array.from(set)){
         const r=new RegExp(`\\b${escaparRegExp(w)}\\b`,'i');
         if(o.match(r)){
             const s=o.replace(r,`<input class='input-ej' data-respuesta='${w}' placeholder='...'>`);
             
             const div=document.createElement('div');div.className='ejercicio-frase';
             div.innerHTML=`
                <div>${s}</div>
                <div class='flexrow'>
                  <span class="tag">${w}</span>
                  <button class='small' onclick="leerTextoOriginal('${w}')">ğŸ”Š Escuchar voz IA</button>
                  <button class='small secondary' onclick="grabarPalabra('${w}', this)">ğŸ™ Grabar mi voz</button>
                  <button class='small' onclick="playSingleWord('${w}')">â–¶ Mi grabaciÃ³n</button>
                </div>`;
             l.appendChild(div);
             set.delete(w);creados++;break;
         }
     }
  }
  
  // Evento de validaciÃ³n inputs
  l.addEventListener('change',e=>{
     if(e.target.classList.contains('input-ej')){
         const r=e.target.dataset.respuesta.toLowerCase();
         const v=e.target.value.trim().toLowerCase();
         if(v===r){
             e.target.classList.add('ok');e.target.classList.remove('bad');
             mostrarNoti(`âœ… Correcto!`,1500);
         }else{
             e.target.classList.add('bad');e.target.classList.remove('ok');
             mostrarNoti(`âŒ Intenta de nuevo.`,1500);
         }
     }
  });
}

/* === GRABACIÃ“N Y AUDIO === */
let globalStream=null;

async function grabarPalabra(w,btn){
 try{
  if(!navigator.mediaDevices)return mostrarNoti('ğŸ¤ No soportado.');
  const s=globalStream||await navigator.mediaDevices.getUserMedia({audio:true});globalStream=s;
  const rec=new MediaRecorder(s);const ch=[];
  
  rec.ondataavailable=e=>{if(e.data.size)ch.push(e.data);};
  rec.start();
  
  const originalText = btn.textContent;
  btn.textContent='âº Grabando...';btn.classList.add('bad');btn.disabled=true;
  
  // Grabar por 2 segundos (ajustable)
  await new Promise(r=>setTimeout(r,2000));
  
  rec.stop();
  rec.onstop=async()=>{
      const b=new Blob(ch,{type:'audio/webm'});
      const base64=await blobToBase64(b);
      
      const st=cargarEstado();
      st.audios[w]={base64,t:Date.now()};
      if(!st.learned.includes(w)) st.learned.push(w); // Marcar como aprendida
      guardarEstado(st);
      
      btn.textContent=originalText; btn.classList.remove('bad'); btn.disabled=false;
      mostrarNoti(`ğŸ™ Audio guardado para "${w}"`,2000);
      renderFragments(); // Recargar UI
  }
 }catch(e){mostrarNoti('Error: '+e.message,2000); btn.disabled=false;}
}

function playSingleWord(w){
    const s=cargarEstado();
    const i=s.audios[w];
    if(!i)return mostrarNoti('No has grabado esta palabra.');
    const a=new Audio(i.base64);
    a.play();
}

function leerTextoOriginal(txt){
    if(!('speechSynthesis'in window))return;
    speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(txt);
    u.lang=document.getElementById('idiomaSelect').value;
    speechSynthesis.speak(u);
}

/* === EL CÃ“DIGO CLAVE: MEZCLADOR INTELIGENTE (ASÃNCRONO) === */

// Helper para esperar milisegundos (Promesa)
const esperar = ms => new Promise(r => setTimeout(r, ms));

// Helper para reproducir Audio Base64 (Promesa)
const reproducirAudioBlob = (base64) => {
    return new Promise((resolve, reject) => {
        const a = new Audio(base64);
        a.onended = () => resolve();
        a.onerror = (e) => resolve(); // Si falla, sigue adelante
        a.play().catch(e => resolve()); // Si el navegador bloquea, sigue
    });
};

// Helper para reproducir TTS (Promesa)
const hablarTexto = (texto, lang) => {
    return new Promise((resolve) => {
        if(!texto.trim()) { resolve(); return; }
        const u = new SpeechSynthesisUtterance(texto);
        u.lang = lang;
        u.onend = () => resolve();
        u.onerror = () => resolve();
        speechSynthesis.speak(u);
    });
};

async function playSmartMix(fragmentoTexto) {
    // 1. PreparaciÃ³n
    speechSynthesis.cancel();
    const { audios } = cargarEstado();
    const lang = document.getElementById('idiomaSelect').value;
    
    // Obtener configuraciÃ³n de pausas del panel
    const pausaPre = parseInt(document.getElementById('pausePre').value) || 200;
    const pausaPost = parseInt(document.getElementById('pausePost').value) || 300;

    // 2. Identificar quÃ© palabras tienen audio grabado
    // Filtramos las keys del objeto audios para ver cuales estÃ¡n en este texto
    const palabrasGrabadas = Object.keys(audios).filter(w => {
        const regex = new RegExp(`\\b${escaparRegExp(w)}\\b`, 'i');
        return regex.test(fragmentoTexto);
    });

    if (palabrasGrabadas.length === 0) {
        mostrarNoti("No hay grabaciones en este fragmento. Leyendo normal...", 2000);
        return leerTextoOriginal(fragmentoTexto);
    }

    mostrarNoti("â–¶ Reproduciendo mezcla...", 3000);

    // 3. LA MAGIA: Split inteligente
    // Creamos una Regex gigante con todas las palabras grabadas: /\b(perro|gato|casa)\b/gi
    // Usamos parÃ©ntesis de captura () para que el .split() incluya las palabras en el array resultante
    const patronGigante = new RegExp(`\\b(${palabrasGrabadas.map(escaparRegExp).join('|')})\\b`, 'gi');
    
    // Al hacer split con captura, el array queda: ["Texto antes ", "palabra", " texto despues"]
    const partes = fragmentoTexto.split(patronGigante);

    // 4. EjecuciÃ³n Secuencial
    for (let parte of partes) {
        if (!parte) continue; // Saltar partes vacÃ­as

        const palabraClean = parte.toLowerCase().trim();
        
        // Â¿Es esta parte una de nuestras palabras grabadas?
        if (audios[palabraClean]) {
            // SI: Es una grabaciÃ³n
            await esperar(pausaPre); // Pausa controlada usuario
            
            // Efecto visual (opcional, busca botÃ³n si existe)
            // podriamos aÃ±adir clase 'active' a los botones aquÃ­
            
            await reproducirAudioBlob(audios[palabraClean].base64);
            
            await esperar(pausaPost); // Pausa controlada usuario
        } else {
            // NO: Es texto normal (puente entre grabaciones)
            if(parte.trim().length > 0) {
                await hablarTexto(parte, lang);
            }
        }
    }
    
    mostrarNoti("âœ… Fin de reproducciÃ³n", 2000);
}

function limpiarProgreso(){
    if(confirm("Â¿Borrar todo el progreso y audios?")){
        localStorage.clear();
        location.reload();
    }
}
</script>
</body>
</html>
