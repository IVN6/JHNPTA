<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Prototipo Aprendizaje v6 ‚Äî Fluido + Control de Tiempos</title>
<style>
  body {font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#f4f7f6;color:#222;max-width:1000px;margin:18px auto;padding:18px;}
  h1,h2,h3 {color:#005a8d;}
  textarea {width:100%;min-height:140px;padding:10px;font-size:15px;border-radius:6px;border:1px solid #ccc;box-sizing: border-box;}
  button {background:#0073b1;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;margin:4px;}
  button.small {padding:6px 8px;font-size:13px;}
  button.secondary {background:#6c757d;}
  button.success {background:#28a745;}
  button:disabled {opacity: 0.6; cursor: not-allowed;}
  
  .panel {background:white;border:1px solid #e0e0e0;border-radius:8px;padding:12px;margin-top:14px;}
  .ejercicio-frase{font-size:1.05em;margin:10px 0;line-height:1.6;}
  input.input-ej{padding:6px 8px;border-radius:6px;border:1px solid #ccc;font-size:15px;}
  .ok{border-color:#28a745!important;background:#eaffea;}
  .bad{border-color:#dc3545!important;background:#ffeaea;}
  .fragment{border:1px dashed #ddd;padding:10px;margin:8px 0;border-radius:6px;background:#fafafa;}
  .tag{background:#e6f4ff;color:#005a8d;padding:6px 8px;border-radius:999px;border:1px solid #d0eaff;}
  .audio-btn{background:#fff;color:#0073b1;border:1px solid #0073b1;padding:2px 6px;border-radius:4px;cursor:pointer;font-size:0.9em;margin:0 2px;}
  .flexrow{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
  
  /* Estilos del Panel de Control de Pausas */
  .control-panel { background: #fff8e1; border: 1px solid #ffe082; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
  .slider-group { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; font-size: 0.9em; }
  .slider-group input { flex: 1; }

  #notify {position:fixed;bottom:20px;right:20px;background:#005a8d;color:white;padding:10px 14px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.2);opacity:0;transition:opacity 0.4s; z-index: 100;}
  #notify.show{opacity:1;}
</style>
</head>
<body>

<h1>Prototipo v6 (Smart Flow)</h1>

<div class="control-panel">
  <h3>üéõÔ∏è Control de Mezcla (Pausas)</h3>
  <div class="slider-group">
    <label>Pausa ANTES de mi voz (ms): <span id="valPre">200</span></label>
    <input type="range" id="pausePre" min="0" max="2000" step="50" value="200" oninput="document.getElementById('valPre').innerText=this.value">
  </div>
  <div class="slider-group">
    <label>Pausa DESPU√âS de mi voz (ms): <span id="valPost">300</span></label>
    <input type="range" id="pausePost" min="0" max="2000" step="50" value="300" oninput="document.getElementById('valPost').innerText=this.value">
  </div>
  <small style="color:#666;">Ajusta cu√°nto silencio quieres antes y despu√©s de insertar tus grabaciones en el texto.</small>
</div>

<div class="flexrow">
  <button onclick="procesarTexto()">Procesar Texto</button>
  <label>Idioma:
    <select id="idiomaSelect">
      <option value="en-US" selected>Ingl√©s üá∫üá∏</option>
      <option value="es-ES">Espa√±ol üá™üá∏</option>
      <option value="fr-FR">Franc√©s üá´üá∑</option>
      <option value="de-DE">Alem√°n üá©üá™</option>
    </select>
  </label>
  <button class="secondary" onclick="limpiarProgreso()">Limpiar todo</button>
</div>

<textarea id="textoUsuario">The quick brown fox jumps over the lazy dog. This is a sentence to test the processing. The dog is lazy, and the fox is quick. Learning a new language is a journey.</textarea>

<div id="resultados" class="panel" style="display:none;">
  <h2>An√°lisis</h2>
  <div id="metricasTexto"></div>
</div>

<div id="fragmentsContainer" class="panel" style="display:none;">
  <h2>Fragmentos (Lectura Inteligente)</h2>
  <div id="fragments"></div>
</div>

<div id="ejercicios" class="panel" style="display:none;">
  <h2>Ejercicios (Grabaci√≥n)</h2>
  <div id="listaEjercicios"></div>
</div>

<div id="notify"></div>

<script>
/* === CONSTANTES Y UTILIDADES === */
const STOP_WORDS = new Set(['a','an','and','the','is','it','in','on','at','to','for','of','with','this','that','was','are','be','over','new','makes','s','i','you','he','she','they','we','my','his','her']);
const STORAGE_KEYS={learned:'ap_v6_learned',audios:'ap_v6_audios'};

function cargarEstado(){return{learned:JSON.parse(localStorage.getItem(STORAGE_KEYS.learned)||'[]'),audios:JSON.parse(localStorage.getItem(STORAGE_KEYS.audios)||'{}')}};
function guardarEstado(s){localStorage.setItem(STORAGE_KEYS.learned,JSON.stringify(s.learned||[]));localStorage.setItem(STORAGE_KEYS.audios,JSON.stringify(s.audios||{}));}

function limpiarTexto(t){return t.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()\"\[\]]/g,"").toLowerCase();}
function palabrasTokenize(t){return limpiarTexto(t).split(/\s+/).filter(p=>p.length>0);}
function mostrarNoti(txt,ms=2500){const n=document.getElementById('notify');n.textContent=txt;n.classList.add('show');setTimeout(()=>n.classList.remove('show'),ms);}
function blobToBase64(b){return new Promise((res,rej)=>{const r=new FileReader();r.onloadend=()=>res(r.result);r.onerror=rej;r.readAsDataURL(b);});}
function escaparRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); } // Para evitar errores si la palabra tiene simbolos

let globalFragments=[];
let globalTopWords=[];

/* === PROCESAMIENTO PRINCIPAL === */
function procesarTexto(){
  const t=document.getElementById('textoUsuario').value.trim();if(!t)return mostrarNoti('‚ö†Ô∏è Escribe un texto primero.',2000);
  
  // Analisis basico
  const or=t.match(/[^.!?]+[.!?]+/g)||[t];
  const palabras=palabrasTokenize(t);
  const freq={};
  
  for(const p of palabras){
    if(p.length>1 && !STOP_WORDS.has(p)){
        freq[p]=(freq[p]||0)+1;
    }
  }
  
  const top=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,10);
  globalTopWords=top;
  
  document.getElementById('metricasTexto').innerHTML=`Total palabras: <b>${palabras.length}</b> ¬∑ Oraciones: <b>${or.length}</b>`;
  document.getElementById('resultados').style.display='block';
  
  // Dividir en fragmentos (chunks)
  dividirEnFragmentos(t);
  
  generarEjercicios(or,top); 
  renderFragments(); 
  
  document.getElementById('fragmentsContainer').style.display='block';
  document.getElementById('ejercicios').style.display='block';
}

function dividirEnFragmentos(t, maxChars=300){
    let or=t.match(/[^.!?]+[.!?]*/g)||[t];
    or=or.map(s=>s.trim()).filter(s=>s.length>0);
    const frags=[];let cur='';
    for(const s of or){
        if(cur.length+s.length+1<=maxChars||cur.length===0) cur+=(cur?' ':'')+s;
        else{ frags.push(cur.trim()); cur=s; }
    }
    if(cur) frags.push(cur.trim());
    globalFragments = frags;
}

/* === RENDERIZADO VISUAL === */
function renderFragments(){
  const {learned,audios}=cargarEstado();
  const lang=document.getElementById('idiomaSelect').value;
  const c=document.getElementById('fragments');
  c.innerHTML='';
  
  globalFragments.forEach((frag,i)=>{
    // Renderizado visual: resaltar palabras con audio
    let html=frag;
    // Solo reemplazamos visualmente si tenemos el audio
    learned.forEach(w=>{
       if(audios[w]) {
           const r=new RegExp(`\\b(${escaparRegExp(w)})\\b`,'ig');
           html=html.replace(r,`<button class='audio-btn' onclick="playSingleWord('${w}')">üéß $1</button>`);
       }
    });

    const d=document.createElement('div');d.className='fragment';
    d.innerHTML=`
        <div><b>Fragmento ${i+1}</b></div>
        <div style="margin-top:6px; line-height:1.6;">${html}</div>
        <div class='flexrow' style='margin-top:12px; border-top:1px solid #eee; padding-top:8px;'>
           <button class='small' onclick="leerTextoOriginal('${frag}')">üó£Ô∏è Escuchar Original (TTS)</button>
           <button class='small success' onclick="playSmartMix('${frag}')">‚ú® Escuchar MEZCLA Inteligente</button>
        </div>`;
    c.appendChild(d);
  });
}

function generarEjercicios(ors,top){
  const l=document.getElementById('listaEjercicios');l.innerHTML='';
  const set=new Set(top.map(p=>p[0]));
  let creados=0;
  
  // Limitar a 10 ejercicios para no saturar
  for(const o of ors){
     if(creados>=10)break;
     for(const w of Array.from(set)){
         const r=new RegExp(`\\b${escaparRegExp(w)}\\b`,'i');
         if(o.match(r)){
             const s=o.replace(r,`<input class='input-ej' data-respuesta='${w}' placeholder='...'>`);
             
             const div=document.createElement('div');div.className='ejercicio-frase';
             div.innerHTML=`
                <div>${s}</div>
                <div class='flexrow'>
                  <span class="tag">${w}</span>
                  <button class='small' onclick="leerTextoOriginal('${w}')">üîä Escuchar voz IA</button>
                  <button class='small secondary' onclick="grabarPalabra('${w}', this)">üéô Grabar mi voz</button>
                  <button class='small' onclick="playSingleWord('${w}')">‚ñ∂ Mi grabaci√≥n</button>
                </div>`;
             l.appendChild(div);
             set.delete(w);creados++;break;
         }
     }
  }
  
  // Evento de validaci√≥n inputs
  l.addEventListener('change',e=>{
     if(e.target.classList.contains('input-ej')){
         const r=e.target.dataset.respuesta.toLowerCase();
         const v=e.target.value.trim().toLowerCase();
         if(v===r){
             e.target.classList.add('ok');e.target.classList.remove('bad');
             mostrarNoti(`‚úÖ Correcto!`,1500);
         }else{
             e.target.classList.add('bad');e.target.classList.remove('ok');
             mostrarNoti(`‚ùå Intenta de nuevo.`,1500);
         }
     }
  });
}

/* === GRABACI√ìN Y AUDIO === */
let globalStream=null;

async function grabarPalabra(w,btn){
 try{
  if(!navigator.mediaDevices)return mostrarNoti('üé§ No soportado.');
  const s=globalStream||await navigator.mediaDevices.getUserMedia({audio:true});globalStream=s;
  const rec=new MediaRecorder(s);const ch=[];
  
  rec.ondataavailable=e=>{if(e.data.size)ch.push(e.data);};
  rec.start();
  
  const originalText = btn.textContent;
  btn.textContent='‚è∫ Grabando...';btn.classList.add('bad');btn.disabled=true;
  
  // Grabar por 2 segundos (ajustable)
  await new Promise(r=>setTimeout(r,2000));
  
  rec.stop();
  rec.onstop=async()=>{
      const b=new Blob(ch,{type:'audio/webm'});
      const base64=await blobToBase64(b);
      
      const st=cargarEstado();
      st.audios[w]={base64,t:Date.now()};
      if(!st.learned.includes(w)) st.learned.push(w); // Marcar como aprendida
      guardarEstado(st);
      
      btn.textContent=originalText; btn.classList.remove('bad'); btn.disabled=false;
      mostrarNoti(`üéô Audio guardado para "${w}"`,2000);
      renderFragments(); // Recargar UI
  }
 }catch(e){mostrarNoti('Error: '+e.message,2000); btn.disabled=false;}
}

function playSingleWord(w){
    const s=cargarEstado();
    const i=s.audios[w];
    if(!i)return mostrarNoti('No has grabado esta palabra.');
    const a=new Audio(i.base64);
    a.play();
}

function leerTextoOriginal(txt){
    if(!('speechSynthesis'in window))return;
    speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(txt);
    u.lang=document.getElementById('idiomaSelect').value;
    speechSynthesis.speak(u);
}

/* === EL C√ìDIGO CLAVE: MEZCLADOR INTELIGENTE (AS√çNCRONO) === */

// Helper para esperar milisegundos (Promesa)
const esperar = ms => new Promise(r => setTimeout(r, ms));

// Helper para reproducir Audio Base64 (Promesa)
const reproducirAudioBlob = (base64) => {
    return new Promise((resolve, reject) => {
        const a = new Audio(base64);
        a.onended = () => resolve();
        a.onerror = (e) => resolve(); // Si falla, sigue adelante
        a.play().catch(e => resolve()); // Si el navegador bloquea, sigue
    });
};

// Helper para reproducir TTS (Promesa)
const hablarTexto = (texto, lang) => {
    return new Promise((resolve) => {
        if(!texto.trim()) { resolve(); return; }
        const u = new SpeechSynthesisUtterance(texto);
        u.lang = lang;
        u.onend = () => resolve();
        u.onerror = () => resolve();
        speechSynthesis.speak(u);
    });
};

async function playSmartMix(fragmentoTexto) {
    // 1. Preparaci√≥n
    speechSynthesis.cancel();
    const { audios } = cargarEstado();
    const lang = document.getElementById('idiomaSelect').value;
    
    // Obtener configuraci√≥n de pausas del panel
    const pausaPre = parseInt(document.getElementById('pausePre').value) || 200;
    const pausaPost = parseInt(document.getElementById('pausePost').value) || 300;

    // 2. Identificar qu√© palabras tienen audio grabado
    // Filtramos las keys del objeto audios para ver cuales est√°n en este texto
    const palabrasGrabadas = Object.keys(audios).filter(w => {
        const regex = new RegExp(`\\b${escaparRegExp(w)}\\b`, 'i');
        return regex.test(fragmentoTexto);
    });

    if (palabrasGrabadas.length === 0) {
        mostrarNoti("No hay grabaciones en este fragmento. Leyendo normal...", 2000);
        return leerTextoOriginal(fragmentoTexto);
    }

    mostrarNoti("‚ñ∂ Reproduciendo mezcla...", 3000);

    // 3. LA MAGIA: Split inteligente
    // Creamos una Regex gigante con todas las palabras grabadas: /\b(perro|gato|casa)\b/gi
    // Usamos par√©ntesis de captura () para que el .split() incluya las palabras en el array resultante
    const patronGigante = new RegExp(`\\b(${palabrasGrabadas.map(escaparRegExp).join('|')})\\b`, 'gi');
    
    // Al hacer split con captura, el array queda: ["Texto antes ", "palabra", " texto despues"]
    const partes = fragmentoTexto.split(patronGigante);

    // 4. Ejecuci√≥n Secuencial
    for (let parte of partes) {
        if (!parte) continue; // Saltar partes vac√≠as

        const palabraClean = parte.toLowerCase().trim();
        
        // ¬øEs esta parte una de nuestras palabras grabadas?
        if (audios[palabraClean]) {
            // SI: Es una grabaci√≥n
            await esperar(pausaPre); // Pausa controlada usuario
            
            // Efecto visual (opcional, busca bot√≥n si existe)
            // podriamos a√±adir clase 'active' a los botones aqu√≠
            
            await reproducirAudioBlob(audios[palabraClean].base64);
            
            await esperar(pausaPost); // Pausa controlada usuario
        } else {
            // NO: Es texto normal (puente entre grabaciones)
            if(parte.trim().length > 0) {
                await hablarTexto(parte, lang);
            }
        }
    }
    
    mostrarNoti("‚úÖ Fin de reproducci√≥n", 2000);
}

function limpiarProgreso(){
    if(confirm("¬øBorrar todo el progreso y audios?")){
        localStorage.clear();
        location.reload();
    }
}
</script>
</body>
</html><!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Caja Registradora - Restaurante (offline)</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#9aa7b2;--success:#10b981}
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
    body{margin:0;background:linear-gradient(180deg,#071020 0%, #0b1a2a 100%);color:#e6f0f2;padding:18px}
    .wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 380px;gap:18px}
    header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:20px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);}
    .left .card{margin-bottom:16px}
    .editor{display:grid;grid-template-columns:1fr 120px;gap:8px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px}
    .row{display:flex;gap:8px}
    button{padding:8px 10px;border-radius:10px;border:0;background:var(--accent);color:#032;cursor:pointer}
    .small{padding:6px 8px;font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px}
    .payments{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .indicator{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px}
    .positive{color:var(--success)}
    .list{max-height:260px;overflow:auto;margin-top:12px}
    .controls{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted);font-size:13px}
    .big-total{font-size:26px;font-weight:700}
    .flex-col{display:flex;flex-direction:column}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:10px;font-size:13px}
    footer{grid-column:1/-1;margin-top:12px;color:var(--muted);font-size:13px}
    @media(max-width:980px){.wrap{grid-template-columns:1fr;}.editor{grid-template-columns:1fr}.payments{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Caja Registradora ‚Äî Restaurante</h1>
      <div class="controls">
        <button id="btn-link-file" class="small">Vincular archivo (opcional)</button>
        <button id="btn-export" class="small">Exportar respaldo</button>
        <input id="file-import" type="file" accept="application/json" style="display:none" />
        <button id="btn-import" class="small">Importar respaldo</button>
        <div id="status" class="muted">Estado: <span id="status-text">Cargando...</span></div>
      </div>
    </header>

    <section class="left">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">Nueva comanda</div>
            <div class="big-total" id="comanda-total">$0.00</div>
          </div>
          <div class="chip" id="today-date"></div>
        </div>

        <div style="margin-top:8px">
          <label>Item (ej. Empanada)</label>
          <input id="item-name" placeholder="Nombre del producto..." />
        </div>
        <div class="row" style="margin-top:8px">
          <div style="flex:1">
            <label>Cantidad</label>
            <input id="item-qty" type="number" value="1" min="1" />
          </div>
          <div style="width:140px">
            <label>Precio unitario</label>
            <input id="item-price" type="number" value="0" min="0" />
          </div>
        </div>
        <div style="margin-top:8px">
          <label>Comentario (opcional)</label>
          <input id="item-note" placeholder="Sin queso, extra salsa..." />
        </div>

        <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
          <select id="payment-type">
            <option value="Efectivo">Efectivo</option>
            <option value="Tarjeta">Tarjeta</option>
            <option value="Nequi">Nequi</option>
            <option value="Otro">Otro</option>
          </select>
          <button id="btn-add-item">A√±adir item</button>
          <button id="btn-add-comanda" class="small">Cerrar comanda (vender)</button>
        </div>

        <div class="list" id="comanda-list"></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">Pagos / Movimiento especial</div>
            <div style="font-weight:600">Registrar pago al empleado / compra</div>
          </div>
        </div>
        <div style="margin-top:8px;display:grid;grid-template-columns:1fr 160px;gap:8px">
          <div>
            <label>Tipo de movimiento</label>
            <select id="mov-type">
              <option value="Nomina">Pago N√≥mina</option>
              <option value="Compra">Compra / Gasto</option>
              <option value="Credito">Dejar a cuenta (acreedor/acreedora)</option>
            </select>
          </div>
          <div>
            <label>M√©todo de pago</label>
            <select id="mov-paymethod">
              <option value="Efectivo">Efectivo</option>
              <option value="Tarjeta">Tarjeta</option>
              <option value="Nequi">Nequi</option>
              <option value="Otro">Otro</option>
            </select>
          </div>
        </div>
        <div style="margin-top:8px;display:grid;grid-template-columns:1fr 120px;gap:8px">
          <div>
            <label>Descripci√≥n (persona o concepto)</label>
            <input id="mov-desc" placeholder="Empleado: Juan - Papa" />
          </div>
          <div>
            <label>Monto</label>
            <input id="mov-amount" type="number" value="0" />
          </div>
        </div>
        <div style="margin-top:8px">
          <label>Comentario (opcional)</label>
          <input id="mov-note" placeholder="Detalles..." />
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="btn-add-mov">Registrar movimiento</button>
          <button id="btn-mark-paid" class="small">Marcar cr√©dito como pago</button>
        </div>

        <div class="list" id="mov-list"></div>
      </div>

    </section>

    <aside>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">Resumen del d√≠a</div>
            <div style="font-size:20px;font-weight:700" id="day-total">$0.00</div>
          </div>
          <div class="muted">Transacciones: <span id="trx-count">0</span></div>
        </div>

        <div style="margin-top:10px" class="payments" id="payment-indicators">
          <!-- din√°mico -->
        </div>

        <div style="margin-top:10px">
          <div class="muted">Filtros</div>
          <div style="display:flex;gap:6px;margin-top:6px">
            <button id="filter-all" class="small">Hoy</button>
            <button id="filter-sales" class="small">Ventas</button>
            <button id="filter-movs" class="small">Movimientos</button>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="muted">√öltimas transacciones</div>
          <div class="list" id="recent-list"></div>
        </div>

      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="muted">Respaldo autom√°tico</div>
          <div class="muted">Intervalo: <span id="backup-interval-text">60s</span></div>
        </div>
        <div style="margin-top:8px" class="actions">
          <button id="btn-auto-backup" class="small">Forzar respaldo</button>
          <button id="btn-toggle-auto" class="small">Activar auto (60s)</button>
        </div>
        <div style="margin-top:8px" class="muted">Sugerencia: vincula un archivo con el API de archivos del navegador para que la app pueda reescribir su propio respaldo (Chromium)</div>
      </div>
    </aside>

    <footer>Hecho con ‚ù§Ô∏è ‚Äî Sin backend. Guarda en localStorage + archivo opcional (File System Access API). Puedes exportar/importar JSON o vincular un archivo para reescritura autom√°tica. Sugerencias al final.</footer>
  </div>

  <script>
    // --- Estructura de datos
    const STORAGE_KEY = 'pos_restaurante_v1';
    let state = {
      sales: [], // {id, items:[{name,qty,price,note}], total, paymentType, date}
      movements: [], // {id,type (Nomina/Compra/Credito), desc, amount, payMethod, note, date, paid}
      lastBackup: null,
    };

    // file handle for File System Access (optional)
    let fileHandle = null;
    let autoBackupInterval = 60; // seconds
    let autoBackupTimer = null;

    // helpers
    const $ = id => document.getElementById(id);
    const money = v => '$' + Number(v).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    const uid = ()=> Date.now().toString(36) + Math.random().toString(36).slice(2,6);

    // load
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){ state = JSON.parse(raw); setStatus('Datos cargados desde localStorage'); }
        else setStatus('Nuevo d√≠a ‚Äî sin datos previos');
      }catch(e){ console.error(e); setStatus('Error cargando localStorage'); }
    }

    function saveState(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        state.lastBackup = new Date().toISOString();
        // if file handle available, attempt to write
        if(fileHandle && window.showSaveFilePicker){
          writeToLinkedFile();
        }
      }catch(e){console.error(e);setStatus('Error guardando');}
    }

    async function writeToLinkedFile(){
      try{
        const writable = await fileHandle.createWritable();
        await writable.write(JSON.stringify(state, null, 2));
        await writable.close();
        setStatus('Guardado en archivo vinculado');
      }catch(e){console.warn('No se pudo escribir en el archivo vinculado', e);}
    }

    // UI actions
    function render(){
      // date
      $('today-date').textContent = new Date().toLocaleString();

      // comanda list
      const cl = $('comanda-list'); cl.innerHTML='';
      let currentComanda = JSON.parse(sessionStorage.getItem('current_comanda')||'null') || {items:[]};
      const comandaTotal = currentComanda.items.reduce((s,it)=>s + it.qty * it.price,0);
      $('comanda-total').textContent = money(comandaTotal);

      if(currentComanda.items.length===0){ cl.innerHTML='<div class="muted">No hay items en la comanda.</div>'}
      else{
        const t = document.createElement('table');
        t.innerHTML = '<thead><tr><th>Item</th><th>qty</th><th>precio</th><th></th></tr></thead>';
        const tb = document.createElement('tbody');
        currentComanda.items.forEach((it,idx)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${it.name} <div class="muted">${it.note||''}</div></td><td>${it.qty}</td><td>${money(it.price*it.qty)}</td><td><button class="small" data-idx="${idx}">Eliminar</button></td>`;
          tb.appendChild(tr);
        });
        t.appendChild(tb); cl.appendChild(t);
        // attach delete handlers
        cl.querySelectorAll('button').forEach(b=>b.addEventListener('click', e=>{
          const i = Number(e.target.dataset.idx);
          currentComanda.items.splice(i,1);
          sessionStorage.setItem('current_comanda', JSON.stringify(currentComanda));
          render();
        }));
      }

      // movements list
      const ml = $('mov-list'); ml.innerHTML='';
      if(state.movements.length===0) ml.innerHTML='<div class="muted">Sin movimientos registrados</div>';
      else{
        const t = document.createElement('table');
        t.innerHTML = '<thead><tr><th>Tipo</th><th>Desc</th><th>Monto</th><th></th></tr></thead>';
        const tb = document.createElement('tbody');
        state.movements.slice().reverse().forEach(m=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${m.type}${m.paid? ' ‚úÖ':''}</td><td>${m.desc}<div class="muted">${m.note||''}</div></td><td>${money(m.amount)} (${m.payMethod})</td><td><button class="small" data-id="${m.id}">Eliminar</button></td>`;
          tb.appendChild(tr);
        });
        t.appendChild(tb); ml.appendChild(t);
        ml.querySelectorAll('button').forEach(b=>b.addEventListener('click', e=>{
          const id = e.target.dataset.id; state.movements = state.movements.filter(x=>x.id!==id); saveState(); render();
        }));
      }

      // summary
      const dayTotal = state.sales.reduce((s,x)=>s + x.total,0) + state.movements.reduce((s,m)=>{
        // compras y nominas deben restar del total del d√≠a (gastos)
        return s + (m.type==='Compra' || m.type==='Nomina' ? -m.amount : 0);
      },0);
      $('day-total').textContent = money(dayTotal);
      $('trx-count').textContent = (state.sales.length + state.movements.length);

      // payment indicators
      const payments = {};
      state.sales.forEach(s=> payments[s.paymentType] = (payments[s.paymentType]||0) + s.total);
      state.movements.forEach(m=> payments[m.payMethod] = (payments[m.payMethod]||0) + (m.type==='Compra'||m.type==='Nomina' ? -m.amount : (m.type==='Credito'?0:m.amount)) );

      const pi = $('payment-indicators'); pi.innerHTML='';
      Object.keys(payments).forEach(k=>{
        const v = payments[k];
        const div = document.createElement('div'); div.className='indicator card';
        div.innerHTML = `<div>${k}</div><div class="positive">${money(v)}</div>`;
        pi.appendChild(div);
      });

      // recent
      const rl = $('recent-list'); rl.innerHTML='';
      const recent = state.sales.concat(state.movements).slice(-10).reverse();
      if(recent.length===0) rl.innerHTML='<div class="muted">No hay transacciones</div>';
      else{
        const ul = document.createElement('div');
        recent.forEach(r=>{
          const d = document.createElement('div'); d.style.marginBottom='8px';
          if(r.items) d.innerHTML = `<div><strong>Venta</strong> ${money(r.total)} <span class="muted">(${r.paymentType})</span></div><div class="muted">${r.items.map(i=>i.name).join(', ')}</div>`;
          else d.innerHTML = `<div><strong>${r.type}</strong> ${money(r.amount)} <span class="muted">${r.payMethod}</span></div><div class="muted">${r.desc} ${r.note||''}</div>`;
          ul.appendChild(d);
        });
        rl.appendChild(ul);
      }

      // indicators for backup
      $('backup-interval-text').textContent = autoBackupInterval + 's';

      // status
      setStatus('Listo ‚Äî cambios guardados: ' + (state.lastBackup? new Date(state.lastBackup).toLocaleString() : 'Nunca'));
    }

    function setStatus(txt){ $('status-text').textContent = txt; }

    // add item
    $('btn-add-item').addEventListener('click', ()=>{
      const name = $('item-name').value.trim();
      const qty = Number($('item-qty').value) || 1;
      const price = Number($('item-price').value) || 0;
      const note = $('item-note').value.trim();
      if(!name){ alert('Ingrese nombre del producto'); return; }
      let comanda = JSON.parse(sessionStorage.getItem('current_comanda')||'null') || {items:[]};
      comanda.items.push({name,qty,price,note});
      sessionStorage.setItem('current_comanda', JSON.stringify(comanda));
      $('item-name').value=''; $('item-note').value=''; $('item-price').value='0'; $('item-qty').value='1';
      render();
    });

    // close comanda / venta
    $('btn-add-comanda').addEventListener('click', ()=>{
      const comanda = JSON.parse(sessionStorage.getItem('current_comanda')||'null');
      if(!comanda || comanda.items.length===0){ alert('No hay items en la comanda'); return; }
      const paymentType = $('payment-type').value;
      const total = comanda.items.reduce((s,it)=>s + it.qty * it.price,0);
      const sale = {id:uid(), items:comanda.items, total, paymentType, date:new Date().toISOString()};
      state.sales.push(sale); saveState();
      sessionStorage.removeItem('current_comanda'); render();
    });

    // movement add
    $('btn-add-mov').addEventListener('click', ()=>{
      const type = $('mov-type').value;
      const payMethod = $('mov-paymethod').value;
      const desc = $('mov-desc').value.trim();
      const amount = Number($('mov-amount').value)||0;
      const note = $('mov-note').value.trim();
      if(!desc){ alert('Ingrese descripci√≥n'); return; }
      if(amount<=0){ alert('Monto debe ser mayor a 0'); return; }
      const mov = {id:uid(), type, desc, amount, payMethod, note, date:new Date().toISOString(), paid: type!=='Credito'};
      state.movements.push(mov); saveState(); render();
    });

    // mark credit as paid
    $('btn-mark-paid').addEventListener('click', ()=>{
      const credits = state.movements.filter(m=>m.type==='Credito' && !m.paid);
      if(credits.length===0){ alert('No hay cr√©ditos pendientes'); return; }
      // simple: mark the first pending as paid via selected paymethod & amount input
      const payMethod = $('mov-paymethod').value; const amount = Number($('mov-amount').value)||0;
      const mov = credits[0]; mov.paid = true; mov.payMethod = payMethod; mov.note = (mov.note||'') + ' | Pagado manualmente';
      saveState(); render();
    });

    // logic for export/import

    
    $('btn-export').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = `pos_backup_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      setStatus('Exportado respaldo');
    });
    $('btn-import').addEventListener('click', ()=> $('file-import').click());
    $('file-import').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return; const text = await f.text(); try{ state = JSON.parse(text); saveState(); render(); alert('Importado con √©xito'); }catch(err){ alert('Error al importar: ' + err.message); }
    });

    // link file (File System Access API)
    $('btn-link-file').addEventListener('click', async ()=>{
      if(!window.showSaveFilePicker){ alert('API de archivos no soportada en este navegador. Use Chrome/Edge o use export/import manual.'); return; }
      try{
        fileHandle = await window.showSaveFilePicker({suggestedName:'pos_backup.json', types:[{description:'JSON', accept:{'application/json':['.json']}}]});
        await writeToLinkedFile();
        setStatus('Archivo vinculado para reescritura autom√°tica');
      }catch(e){ console.warn(e); setStatus('Cancelado vincular archivo'); }
    });

    // force backup
    $('btn-auto-backup').addEventListener('click', ()=>{ $('btn-export').click(); });

    // toggle auto backup
    $('btn-toggle-auto').addEventListener('click', ()=>{
      if(autoBackupTimer){ clearInterval(autoBackupTimer); autoBackupTimer = null; setStatus('Auto backup detenido'); $('btn-toggle-auto').textContent='Activar auto (60s)'; }
      else{
        autoBackupTimer = setInterval(()=>{ saveState(); console.log('Auto backup realizado'); }, autoBackupInterval*1000);
        setStatus('Auto backup activo cada ' + autoBackupInterval + 's'); $('btn-toggle-auto').textContent='Desactivar auto';
      }
    });

    // initialize
    loadState(); render();

    // save when closing
    window.addEventListener('beforeunload', ()=> saveState());
  </script>
</body>
</html>
