<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Prototipo Aprendizaje v6 ‚Äî Fluido + Control de Tiempos</title>
<style>
  body {font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#f4f7f6;color:#222;max-width:1000px;margin:18px auto;padding:18px;}
  h1,h2,h3 {color:#005a8d;}
  textarea {width:100%;min-height:140px;padding:10px;font-size:15px;border-radius:6px;border:1px solid #ccc;box-sizing: border-box;}
  button {background:#0073b1;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;margin:4px;}
  button.small {padding:6px 8px;font-size:13px;}
  button.secondary {background:#6c757d;}
  button.success {background:#28a745;}
  button:disabled {opacity: 0.6; cursor: not-allowed;}
  
  .panel {background:white;border:1px solid #e0e0e0;border-radius:8px;padding:12px;margin-top:14px;}
  .ejercicio-frase{font-size:1.05em;margin:10px 0;line-height:1.6;}
  input.input-ej{padding:6px 8px;border-radius:6px;border:1px solid #ccc;font-size:15px;}
  .ok{border-color:#28a745!important;background:#eaffea;}
  .bad{border-color:#dc3545!important;background:#ffeaea;}
  .fragment{border:1px dashed #ddd;padding:10px;margin:8px 0;border-radius:6px;background:#fafafa;}
  .tag{background:#e6f4ff;color:#005a8d;padding:6px 8px;border-radius:999px;border:1px solid #d0eaff;}
  .audio-btn{background:#fff;color:#0073b1;border:1px solid #0073b1;padding:2px 6px;border-radius:4px;cursor:pointer;font-size:0.9em;margin:0 2px;}
  .flexrow{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
  
  /* Estilos del Panel de Control de Pausas */
  .control-panel { background: #fff8e1; border: 1px solid #ffe082; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
  .slider-group { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; font-size: 0.9em; }
  .slider-group input { flex: 1; }

  #notify {position:fixed;bottom:20px;right:20px;background:#005a8d;color:white;padding:10px 14px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.2);opacity:0;transition:opacity 0.4s; z-index: 100;}
  #notify.show{opacity:1;}
</style>
</head>
<body>

<h1>Prototipo v6 (Smart Flow)</h1>

<div class="control-panel">
  <h3>üéõÔ∏è Control de Mezcla (Pausas)</h3>
  <div class="slider-group">
    <label>Pausa ANTES de mi voz (ms): <span id="valPre">200</span></label>
    <input type="range" id="pausePre" min="0" max="2000" step="50" value="200" oninput="document.getElementById('valPre').innerText=this.value">
  </div>
  <div class="slider-group">
    <label>Pausa DESPU√âS de mi voz (ms): <span id="valPost">300</span></label>
    <input type="range" id="pausePost" min="0" max="2000" step="50" value="300" oninput="document.getElementById('valPost').innerText=this.value">
  </div>
  <small style="color:#666;">Ajusta cu√°nto silencio quieres antes y despu√©s de insertar tus grabaciones en el texto.</small>
</div>

<div class="flexrow">
  <button onclick="procesarTexto()">Procesar Texto</button>
  <label>Idioma:
    <select id="idiomaSelect">
      <option value="en-US" selected>Ingl√©s üá∫üá∏</option>
      <option value="es-ES">Espa√±ol üá™üá∏</option>
      <option value="fr-FR">Franc√©s üá´üá∑</option>
      <option value="de-DE">Alem√°n üá©üá™</option>
    </select>
  </label>
  <button class="secondary" onclick="limpiarProgreso()">Limpiar todo</button>
</div>

<textarea id="textoUsuario">The quick brown fox jumps over the lazy dog. This is a sentence to test the processing. The dog is lazy, and the fox is quick. Learning a new language is a journey.</textarea>

<div id="resultados" class="panel" style="display:none;">
  <h2>An√°lisis</h2>
  <div id="metricasTexto"></div>
</div>

<div id="fragmentsContainer" class="panel" style="display:none;">
  <h2>Fragmentos (Lectura Inteligente)</h2>
  <div id="fragments"></div>
</div>

<div id="ejercicios" class="panel" style="display:none;">
  <h2>Ejercicios (Grabaci√≥n)</h2>
  <div id="listaEjercicios"></div>
</div>
<div id="shadowing" class="panel" style="display:none;">
  <h2>üó£Ô∏è Shadowing Mode (N-Grams)</h2>
  <div class="flexrow">
      <label>Tama√±o de grupo (N):
          <select id="ngramSize">
              <option value="3">3-gram (Trigram)</option>
              <option value="4" selected>4-gram (Quadgram)</option>
              <option value="5">5-gram</option>
          </select>
      </label>
      <button class="success" onclick="iniciarShadowing()">Start Shadowing</button>
  </div>
  <div id="shadowingArea" style="margin-top:15px;">
      </div>
</div>

<div id="notify"></div>

<script>

/* === CONSTANTES Y UTILIDADES === */
const STOP_WORDS = new Set(['a','an','and','the','is','it','in','on','at','to','for','of','with','this','that','was','are','be','over','new','makes','s','i','you','he','she','they','we','my','his','her']);
const STORAGE_KEYS={learned:'ap_v6_learned',audios:'ap_v6_audios', text:'ap_v6_text'}; // A√±adida clave para el texto

function cargarEstado(){return{learned:JSON.parse(localStorage.getItem(STORAGE_KEYS.learned)||'[]'),audios:JSON.parse(localStorage.getItem(STORAGE_KEYS.audios)||'{}')}};
function guardarEstado(s){
    localStorage.setItem(STORAGE_KEYS.learned,JSON.stringify(s.learned||[]));
    localStorage.setItem(STORAGE_KEYS.audios,JSON.stringify(s.audios||{}));
}

// *** NUEVA FUNCI√ìN: Guardar y Cargar Texto (Punto 3) ***
function guardarTextoUsuario() {
    const t = document.getElementById('textoUsuario').value;
    localStorage.setItem(STORAGE_KEYS.text, t);
}
function cargarTextoUsuario() {
    const t = localStorage.getItem(STORAGE_KEYS.text);
    if (t) document.getElementById('textoUsuario').value = t;
}

function limpiarTexto(t){return t.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()\"\[\]]/g,"").toLowerCase();}
function palabrasTokenize(t){return limpiarTexto(t).split(/\s+/).filter(p=>p.length>0);}
function mostrarNoti(txt,ms=2500){const n=document.getElementById('notify');n.textContent=txt;n.classList.add('show');setTimeout(()=>n.classList.remove('show'),ms);}
function blobToBase64(b){return new Promise((res,rej)=>{const r=new FileReader();r.onloadend=()=>res(r.result);r.onerror=rej;r.readAsDataURL(b);});}
function escaparRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

let globalFragments=[];
let globalTopWords=[];

/* === PROCESAMIENTO PRINCIPAL === */
function procesarTexto(){
  let t=document.getElementById('textoUsuario').value.trim();if(!t)return mostrarNoti('‚ö†Ô∏è Escribe un texto primero.',2000);
  
  // Limpieza de texto: Reemplaza saltos de l√≠nea, comillas dobles y otros caracteres de control
  t = t.replace(/[\n\t"‚Äú‚Äû‚Äù‚Äò‚Äô]/g, ' ').replace(/\s{2,}/g, ' ').trim();
  
  // Analisis basico
  const or=t.match(/[^.!?]+[.!?]+/g)||[t];
  const palabras=palabrasTokenize(t);
  const freq={};
  
  for(const p of palabras){
    if(p.length>1 && !STOP_WORDS.has(p)){
        freq[p]=(freq[p]||0)+1;
    }
  }
  
  const top=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,10);
  globalTopWords=top;
  
  document.getElementById('metricasTexto').innerHTML=`Total palabras: <b>${palabras.length}</b> ¬∑ Oraciones: <b>${or.length}</b>`;
  document.getElementById('resultados').style.display='block';
  
  // Dividir en fragmentos (chunks)
  dividirEnFragmentos(t);
  
  // *** CAMBIO: Se elimina la generaci√≥n de ejercicios autom√°ticos ***
  // generarEjercicios(or,top); 
  
  renderFragments(); 
  renderWordList(top); // Nuevo: Renderiza solo la lista de palabras grabadas para grabar individualmente.
  
  document.getElementById('fragmentsContainer').style.display='block';
  document.getElementById('ejercicios').style.display='block'; // Este panel se usar√° para grabar palabras.
  document.getElementById('shadowing').style.display='block';
}

function dividirEnFragmentos(t, maxChars=300){
    let or=t.match(/[^.!?]+[.!?]*/g)||[t];
    or=or.map(s=>s.trim()).filter(s=>s.length>0);
    const frags=[];let cur='';
    for(const s of or){
        if(cur.length+s.length+1<=maxChars||cur.length===0) cur+=(cur?' ':'')+s;
        else{ frags.push(cur.trim()); cur=s; }
    }
    if(cur) frags.push(cur.trim());
    globalFragments = frags;
}

/* === NUEVA FUNCI√ìN PARA N-GRAMS CON PROSODIA === */
function dividirEnNGrams(t, n=4) {
    const tokens = t.match(/[\w']+|[.,?!:;]/g) || []; 
    const nGrams = [];
    let currentGram = "";
    let wordCount = 0;
    
    for (const token of tokens) {
        if (/[.,?!:;]/.test(token) && token !== "'") {
            currentGram += token;
            if (currentGram.trim().length > 0) nGrams.push(currentGram.trim());
            currentGram = "";
            wordCount = 0;
        } 
        else {
            if (wordCount >= n) {
                nGrams.push(currentGram.trim());
                currentGram = token;
                wordCount = 1;
            } else {
                currentGram += (wordCount > 0 ? ' ' : '') + token;
                wordCount++;
            }
        }
    }
    
    if (currentGram.trim().length > 0) {
        nGrams.push(currentGram.trim());
    }
    
    return nGrams.filter(g => g.length > 0);
}


/* === RENDERIZADO VISUAL === */

// Nuevo: Muestra palabras clave y permite grabar
function renderWordList(topWords) {
    const { learned, audios } = cargarEstado();
    const l = document.getElementById('listaEjercicios');
    l.innerHTML = '<h3>Palabras y Frases para Grabar</h3><p><small>Aqu√≠ puedes grabar palabras clave o frases completas para el modo **Mezcla Inteligente**.</small></p>';

    // Lista de todas las palabras o frases grabadas por el usuario
    const allGrabbed = Object.keys(audios).sort((a, b) => b.length - a.length); // Ordenar de m√°s largo a m√°s corto

    let htmlContent = '';
    
    // 1. Mostrar las top words del texto (como sugerencia de vocabulario)
    htmlContent += '<h4>Sugerencias de Vocabulario (Frecuencia)</h4><div class="flexrow" style="margin-bottom:15px;">';
    topWords.forEach(([w]) => {
        htmlContent += `
            <div class='flexrow' style="border:1px solid #ddd; padding:5px; border-radius:6px; background:#f9f9f9;">
                <span class="tag">${w}</span>
                <button class='small' onclick="leerTextoOriginal('${w}')">üîä IA</button>
                <button class='small secondary' onclick="grabarPalabra('${w}', this)">üéô Grabar</button>
                <button class='small' onclick="playSingleWord('${w}')" ${!audios[w] ? 'disabled' : ''}>‚ñ∂ Mi voz</button>
            </div>`;
    });
    htmlContent += '</div>';

    // 2. Secci√≥n para grabar frases completas (manual)
    htmlContent += '<h4>Grabar Frase Completa (Custom)</h4>';
    htmlContent += '<div class="flexrow" style="margin-bottom:15px;"><input type="text" id="customPhrase" placeholder="Escribe tu frase aqu√≠" class="input-ej" style="flex-grow:1;">';
    htmlContent += `<button class='small success' onclick="grabarFraseCustom(document.getElementById('customPhrase').value, this)">üéô Grabar Frase</button>`;
    htmlContent += '</div>';

    // 3. Mostrar grabaciones existentes
    if (allGrabbed.length > 0) {
        htmlContent += '<h4>Mis Grabaciones (Palabras y Frases)</h4><div class="flexrow" style="flex-direction: column; align-items: flex-start;">';
        allGrabbed.forEach(w => {
            htmlContent += `
                <div class='flexrow' style="padding:4px; border-bottom:1px dashed #eee; width:100%; justify-content: space-between;">
                    <span style="font-style: italic; max-width: 60%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${w}</span>
                    <div class="flexrow">
                        <button class='small' onclick="leerTextoOriginal('${w}')">üîä IA</button>
                        <button class='small' onclick="playSingleWord('${w}')">‚ñ∂ Mi voz</button>
                    </div>
                </div>`;
        });
        htmlContent += '</div>';
    }

    l.innerHTML += htmlContent;
}

async function grabarFraseCustom(phrase, btn) {
    if (!phrase.trim()) return mostrarNoti('Escribe una frase para grabar.', 1500);
    // Usamos el texto limpio como key de almacenamiento
    await grabarPalabra(phrase.trim(), btn);
}

function renderFragments(){
  const {learned,audios}=cargarEstado();
  const lang=document.getElementById('idiomaSelect').value;
  const c=document.getElementById('fragments');
  c.innerHTML='';
  
  globalFragments.forEach((frag,i)=>{
    // Renderizado visual: resaltar palabras con audio
    let html=frag;
    
    // Obtener todas las claves de audio grabadas, ordenadas por longitud (m√°s largas primero)
    const sortedAudios = Object.keys(audios).sort((a, b) => b.length - a.length);

    sortedAudios.forEach(w => {
       // Reemplazar la frase/palabra en el fragmento solo si est√° presente
       if (html.toLowerCase().includes(w.toLowerCase())) {
           // Expresi√≥n regular que coincide con toda la palabra/frase
           const r=new RegExp(`(${escaparRegExp(w)})`,'ig');
           // Solo reemplaza el primer match para evitar bucles si hay superposici√≥n, aunque no deber√≠a ocurrir.
           html=html.replace(r,`<button class='audio-btn' onclick="playSingleWord('${w}')">üéß $1</button>`);
       }
    });

    const d=document.createElement('div');d.className='fragment';
    d.innerHTML=`
        <div><b>Fragmento ${i+1}</b></div>
        <div style="margin-top:6px; line-height:1.6;">${html}</div>
        <div class='flexrow' style='margin-top:12px; border-top:1px solid #eee; padding-top:8px;'>
           <button class='small' onclick="leerTextoOriginal('${frag}')">üó£Ô∏è Escuchar Original (TTS)</button>
           <button class='small success' onclick="playSmartMix('${frag}')">‚ú® Escuchar MEZCLA Inteligente</button>
        </div>`;
    c.appendChild(d);
  });
}


/* === GRABACI√ìN Y AUDIO (EXISTENTE) === */
let globalStream=null;

async function grabarPalabra(w,btn){
 try{
  if(!navigator.mediaDevices)return mostrarNoti('üé§ No soportado.');
  const s=globalStream||await navigator.mediaDevices.getUserMedia({audio:true});globalStream=s;
  const rec=new MediaRecorder(s);const ch=[];
  
  rec.ondataavailable=e=>{if(e.data.size)ch.push(e.data);};
  rec.start();
  
  const originalText = btn.textContent;
  btn.textContent='‚è∫ Grabando...';btn.classList.add('bad');btn.disabled=true;
  
  // Grabar por 2 segundos (ajustable)
  await new Promise(r=>setTimeout(r,2000));
  
  rec.stop();
  rec.onstop=async()=>{
      const b=new Blob(ch,{type:'audio/webm'});
      const base64=await blobToBase64(b);
      
      const cleanWord = w.trim();
      
      const st=cargarEstado();
      st.audios[cleanWord]={base64,t:Date.now()};
      if(!st.learned.includes(cleanWord)) st.learned.push(cleanWord); // Marcar como aprendida
      guardarEstado(st);
      
      btn.textContent=originalText; btn.classList.remove('bad'); btn.disabled=false;
      mostrarNoti(`üéô Audio guardado para "${cleanWord}"`,2000);
      renderFragments(); // Recargar UI de fragments
      renderWordList(globalTopWords); // Recargar UI de la lista de grabaci√≥n
  }
 }catch(e){mostrarNoti('Error: '+e.message,2000); btn.disabled=false;}
}


// ... otras funciones de audio (playSingleWord, leerTextoOriginal) se mantienen

/* === EL C√ìDIGO CLAVE: MEZCLADOR INTELIGENTE (AS√çNCRONO) === */

// Helper para esperar milisegundos (Promesa)
const esperar = ms => new Promise(r => setTimeout(r, ms));

// Helper para reproducir Audio Base64 (Promesa)
const reproducirAudioBlob = (base64) => {
    return new Promise((resolve, reject) => {
        const a = new Audio(base64);
        a.onended = () => resolve();
        a.onerror = (e) => resolve(); // Si falla, sigue adelante
        a.play().catch(e => resolve()); // Si el navegador bloquea, sigue
    });
};

// Helper para reproducir TTS (Promesa)
const hablarTexto = (texto, lang) => {
    return new Promise((resolve) => {
        if(!texto.trim()) { resolve(); return; }
        const u = new SpeechSynthesisUtterance(texto);
        u.lang = lang;
        u.onend = () => resolve();
        u.onerror = () => resolve();
        speechSynthesis.speak(u);
    });
};

async function playSmartMix(fragmentoTexto) {
    // 1. Preparaci√≥n
    speechSynthesis.cancel();
    const { audios } = cargarEstado();
    const lang = document.getElementById('idiomaSelect').value;
    
    // Obtener configuraci√≥n de pausas del panel
    const pausaPre = parseInt(document.getElementById('pausePre').value) || 200;
    const pausaPost = parseInt(document.getElementById('pausePost').value) || 300;

    // 2. Identificar y ordenar grabaciones (Punto 2: Priorizar las m√°s largas)
    // Esto asegura que "lazy dog" se pruebe antes que "dog"
    const palabrasGrabadasOrdenadas = Object.keys(audios).sort((a, b) => b.length - a.length);

    if (palabrasGrabadasOrdenadas.length === 0) {
        mostrarNoti("No hay grabaciones en este fragmento. Leyendo normal...", 2000);
        return leerTextoOriginal(fragmentoTexto);
    }

    mostrarNoti("‚ñ∂ Reproduciendo mezcla...", 3000);

    // 3. LA MAGIA: Segmentaci√≥n por la grabaci√≥n m√°s larga que coincida
    let textoRestante = fragmentoTexto;
    const partesMixtas = [];
    
    while (textoRestante.length > 0) {
        let matchFound = false;
        
        // Buscar la grabaci√≥n m√°s larga en el texto restante
        for (const w of palabrasGrabadasOrdenadas) {
            // Usar RegExp para encontrar coincidencias de palabra/frase entera
            const regex = new RegExp(escaparRegExp(w), 'i');
            const match = textoRestante.match(regex);
            
            if (match) {
                const index = match.index;
                const matchLength = match[0].length;

                // 1. Texto anterior (TTS)
                const before = textoRestante.substring(0, index);
                if (before.trim().length > 0) {
                    partesMixtas.push({ type: 'tts', text: before });
                }

                // 2. La palabra/frase grabada (USER AUDIO)
                const grabbedWord = textoRestante.substring(index, index + matchLength);
                partesMixtas.push({ type: 'user', text: grabbedWord, audio: audios[w].base64 });

                // Actualizar el texto restante
                textoRestante = textoRestante.substring(index + matchLength);
                matchFound = true;
                break; // Romper el loop interno para re-evaluar el resto del texto
            }
        }
        
        // Si no se encontr√≥ ninguna grabaci√≥n en el texto restante, el resto es TTS y terminamos
        if (!matchFound) {
            if (textoRestante.trim().length > 0) {
                partesMixtas.push({ type: 'tts', text: textoRestante });
            }
            textoRestante = ""; // Vaciar para salir del while
        }
    }
    
    // 4. Ejecuci√≥n Secuencial
    for (const parte of partesMixtas) {
        if (parte.type === 'user') {
            await esperar(pausaPre);
            await reproducirAudioBlob(parte.audio);
            await esperar(pausaPost);
        } else {
            // Asegurarse de que no haya silencios largos entre pausas
            await hablarTexto(parte.text, lang);
        }
    }
    
    mostrarNoti("‚úÖ Fin de reproducci√≥n", 2000);
}

// ... Las funciones de playSingleWord, leerTextoOriginal, limpiarProgreso se mantienen

/* === SHADOWING MODE CORE LOGIC (SE MANTIENE) === */
let globalNGrams = [];
let currentGramIndex = 0;
let attemptsLeft = 3;
let recognition = null; 
// ... Todas las funciones de Shadowing (iniciarShadowing, handleRecognitionResult, etc.) se mantienen sin cambios, ya que funcionan bien.


/* === INICIALIZACI√ìN Y LISTENERS === */

// Cargar el texto del usuario al inicio
cargarTextoUsuario();

// A√±adir listener para guardar el texto autom√°ticamente
document.getElementById('textoUsuario').addEventListener('input', guardarTextoUsuario);

// A√±adir listener para el input de archivo (Punto 4: Carga de Archivos)
const fileInput = document.createElement('input');
fileInput.type = 'file';
fileInput.accept = '.txt'; 
fileInput.style = 'margin-left: 10px; font-size: 13px;';
fileInput.onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            document.getElementById('textoUsuario').value = event.target.result;
            guardarTextoUsuario();
            mostrarNoti(`Archivo "${file.name}" cargado. ¬°Procesa el texto!`, 3000);
        };
        reader.onerror = () => mostrarNoti('Error al leer el archivo.', 2000);
        reader.readAsText(file);
    }
};

// Insertar el input de archivo en el HTML
const flexrow = document.querySelector('.flexrow');
flexrow.appendChild(fileInput);
                         


  
</script>
  </body>
</html>html>
  
