<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Caja Registradora - Restaurante (offline)</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#9aa7b2;--success:#10b981}
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
    body{margin:0;background:linear-gradient(180deg,#071020 0%, #0b1a2a 100%);color:#e6f0f2;padding:18px}
    .wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 380px;gap:18px}
    header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:20px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);}
    .left .card{margin-bottom:16px}
    .editor{display:grid;grid-template-columns:1fr 120px;gap:8px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px}
    .row{display:flex;gap:8px}
    button{padding:8px 10px;border-radius:10px;border:0;background:var(--accent);color:#032;cursor:pointer}
    .small{padding:6px 8px;font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px}
    .payments{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .indicator{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px}
    .positive{color:var(--success)}
    .list{max-height:260px;overflow:auto;margin-top:12px}
    .controls{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted);font-size:13px}
    .big-total{font-size:26px;font-weight:700}
    .flex-col{display:flex;flex-direction:column}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:10px;font-size:13px}
    footer{grid-column:1/-1;margin-top:12px;color:var(--muted);font-size:13px}
    @media(max-width:980px){.wrap{grid-template-columns:1fr;}.editor{grid-template-columns:1fr}.payments{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Caja Registradora — Restaurante</h1>
      <div class="controls">
        <button id="btn-link-file" class="small">Vincular archivo (opcional)</button>
        <button id="btn-export" class="small">Exportar respaldo</button>
        <input id="file-import" type="file" accept="application/json" style="display:none" />
        <button id="btn-import" class="small">Importar respaldo</button>
        <div id="status" class="muted">Estado: <span id="status-text">Cargando...</span></div>
      </div>
    </header>

    <section class="left">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">Nueva comanda</div>
            <div class="big-total" id="comanda-total">$0.00</div>
          </div>
          <div class="chip" id="today-date"></div>
        </div>

        <div style="margin-top:8px">
          <label>Item (ej. Empanada)</label>
          <input id="item-name" placeholder="Nombre del producto..." />
        </div>
        <div class="row" style="margin-top:8px">
          <div style="flex:1">
            <label>Cantidad</label>
            <input id="item-qty" type="number" value="1" min="1" />
          </div>
          <div style="width:140px">
            <label>Precio unitario</label>
            <input id="item-price" type="number" value="0" min="0" />
          </div>
        </div>
        <div style="margin-top:8px">
          <label>Comentario (opcional)</label>
          <input id="item-note" placeholder="Sin queso, extra salsa..." />
        </div>

        <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
          <select id="payment-type">
            <option value="Efectivo">Efectivo</option>
            <option value="Tarjeta">Tarjeta</option>
            <option value="Nequi">Nequi</option>
            <option value="Otro">Otro</option>
          </select>
          <button id="btn-add-item">Añadir item</button>
          <button id="btn-add-comanda" class="small">Cerrar comanda (vender)</button>
        </div>

        <div class="list" id="comanda-list"></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">Pagos / Movimiento especial</div>
            <div style="font-weight:600">Registrar pago al empleado / compra</div>
          </div>
        </div>
        <div style="margin-top:8px;display:grid;grid-template-columns:1fr 160px;gap:8px">
          <div>
            <label>Tipo de movimiento</label>
            <select id="mov-type">
              <option value="Nomina">Pago Nómina</option>
              <option value="Compra">Compra / Gasto</option>
              <option value="Credito">Dejar a cuenta (acreedor/acreedora)</option>
            </select>
          </div>
          <div>
            <label>Método de pago</label>
            <select id="mov-paymethod">
              <option value="Efectivo">Efectivo</option>
              <option value="Tarjeta">Tarjeta</option>
              <option value="Nequi">Nequi</option>
              <option value="Otro">Otro</option>
            </select>
          </div>
        </div>
        <div style="margin-top:8px;display:grid;grid-template-columns:1fr 120px;gap:8px">
          <div>
            <label>Descripción (persona o concepto)</label>
            <input id="mov-desc" placeholder="Empleado: Juan - Papa" />
          </div>
          <div>
            <label>Monto</label>
            <input id="mov-amount" type="number" value="0" />
          </div>
        </div>
        <div style="margin-top:8px">
          <label>Comentario (opcional)</label>
          <input id="mov-note" placeholder="Detalles..." />
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="btn-add-mov">Registrar movimiento</button>
          <button id="btn-mark-paid" class="small">Marcar crédito como pago</button>
        </div>

        <div class="list" id="mov-list"></div>
      </div>

    </section>

    <aside>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">Resumen del día</div>
            <div style="font-size:20px;font-weight:700" id="day-total">$0.00</div>
          </div>
          <div class="muted">Transacciones: <span id="trx-count">0</span></div>
        </div>

        <div style="margin-top:10px" class="payments" id="payment-indicators">
          <!-- dinámico -->
        </div>

        <div style="margin-top:10px">
          <div class="muted">Filtros</div>
          <div style="display:flex;gap:6px;margin-top:6px">
            <button id="filter-all" class="small">Hoy</button>
            <button id="filter-sales" class="small">Ventas</button>
            <button id="filter-movs" class="small">Movimientos</button>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="muted">Últimas transacciones</div>
          <div class="list" id="recent-list"></div>
        </div>

      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="muted">Respaldo automático</div>
          <div class="muted">Intervalo: <span id="backup-interval-text">60s</span></div>
        </div>
        <div style="margin-top:8px" class="actions">
          <button id="btn-auto-backup" class="small">Forzar respaldo</button>
          <button id="btn-toggle-auto" class="small">Activar auto (60s)</button>
        </div>
        <div style="margin-top:8px" class="muted">Sugerencia: vincula un archivo con el API de archivos del navegador para que la app pueda reescribir su propio respaldo (Chromium)</div>
      </div>
    </aside>

    <footer>Hecho con ❤️ — Sin backend. Guarda en localStorage + archivo opcional (File System Access API). Puedes exportar/importar JSON o vincular un archivo para reescritura automática. Sugerencias al final.</footer>
  </div>

  <script>
    // --- Estructura de datos
    const STORAGE_KEY = 'pos_restaurante_v1';
    let state = {
      sales: [], // {id, items:[{name,qty,price,note}], total, paymentType, date}
      movements: [], // {id,type (Nomina/Compra/Credito), desc, amount, payMethod, note, date, paid}
      lastBackup: null,
    };

    // file handle for File System Access (optional)
    let fileHandle = null;
    let autoBackupInterval = 60; // seconds
    let autoBackupTimer = null;

    // helpers
    const $ = id => document.getElementById(id);
    const money = v => '$' + Number(v).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    const uid = ()=> Date.now().toString(36) + Math.random().toString(36).slice(2,6);

    // load
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){ state = JSON.parse(raw); setStatus('Datos cargados desde localStorage'); }
        else setStatus('Nuevo día — sin datos previos');
      }catch(e){ console.error(e); setStatus('Error cargando localStorage'); }
    }

    function saveState(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        state.lastBackup = new Date().toISOString();
        // if file handle available, attempt to write
        if(fileHandle && window.showSaveFilePicker){
          writeToLinkedFile();
        }
      }catch(e){console.error(e);setStatus('Error guardando');}
    }

    async function writeToLinkedFile(){
      try{
        const writable = await fileHandle.createWritable();
        await writable.write(JSON.stringify(state, null, 2));
        await writable.close();
        setStatus('Guardado en archivo vinculado');
      }catch(e){console.warn('No se pudo escribir en el archivo vinculado', e);}
    }

    // UI actions
    function render(){
      // date
      $('today-date').textContent = new Date().toLocaleString();

      // comanda list
      const cl = $('comanda-list'); cl.innerHTML='';
      let currentComanda = JSON.parse(sessionStorage.getItem('current_comanda')||'null') || {items:[]};
      const comandaTotal = currentComanda.items.reduce((s,it)=>s + it.qty * it.price,0);
      $('comanda-total').textContent = money(comandaTotal);

      if(currentComanda.items.length===0){ cl.innerHTML='<div class="muted">No hay items en la comanda.</div>'}
      else{
        const t = document.createElement('table');
        t.innerHTML = '<thead><tr><th>Item</th><th>qty</th><th>precio</th><th></th></tr></thead>';
        const tb = document.createElement('tbody');
        currentComanda.items.forEach((it,idx)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${it.name} <div class="muted">${it.note||''}</div></td><td>${it.qty}</td><td>${money(it.price*it.qty)}</td><td><button class="small" data-idx="${idx}">Eliminar</button></td>`;
          tb.appendChild(tr);
        });
        t.appendChild(tb); cl.appendChild(t);
        // attach delete handlers
        cl.querySelectorAll('button').forEach(b=>b.addEventListener('click', e=>{
          const i = Number(e.target.dataset.idx);
          currentComanda.items.splice(i,1);
          sessionStorage.setItem('current_comanda', JSON.stringify(currentComanda));
          render();
        }));
      }

      // movements list
      const ml = $('mov-list'); ml.innerHTML='';
      if(state.movements.length===0) ml.innerHTML='<div class="muted">Sin movimientos registrados</div>';
      else{
        const t = document.createElement('table');
        t.innerHTML = '<thead><tr><th>Tipo</th><th>Desc</th><th>Monto</th><th></th></tr></thead>';
        const tb = document.createElement('tbody');
        state.movements.slice().reverse().forEach(m=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${m.type}${m.paid? ' ✅':''}</td><td>${m.desc}<div class="muted">${m.note||''}</div></td><td>${money(m.amount)} (${m.payMethod})</td><td><button class="small" data-id="${m.id}">Eliminar</button></td>`;
          tb.appendChild(tr);
        });
        t.appendChild(tb); ml.appendChild(t);
        ml.querySelectorAll('button').forEach(b=>b.addEventListener('click', e=>{
          const id = e.target.dataset.id; state.movements = state.movements.filter(x=>x.id!==id); saveState(); render();
        }));
      }

      // summary
      const dayTotal = state.sales.reduce((s,x)=>s + x.total,0) + state.movements.reduce((s,m)=>{
        // compras y nominas deben restar del total del día (gastos)
        return s + (m.type==='Compra' || m.type==='Nomina' ? -m.amount : 0);
      },0);
      $('day-total').textContent = money(dayTotal);
      $('trx-count').textContent = (state.sales.length + state.movements.length);

      // payment indicators
      const payments = {};
      state.sales.forEach(s=> payments[s.paymentType] = (payments[s.paymentType]||0) + s.total);
      state.movements.forEach(m=> payments[m.payMethod] = (payments[m.payMethod]||0) + (m.type==='Compra'||m.type==='Nomina' ? -m.amount : (m.type==='Credito'?0:m.amount)) );

      const pi = $('payment-indicators'); pi.innerHTML='';
      Object.keys(payments).forEach(k=>{
        const v = payments[k];
        const div = document.createElement('div'); div.className='indicator card';
        div.innerHTML = `<div>${k}</div><div class="positive">${money(v)}</div>`;
        pi.appendChild(div);
      });

      // recent
      const rl = $('recent-list'); rl.innerHTML='';
      const recent = state.sales.concat(state.movements).slice(-10).reverse();
      if(recent.length===0) rl.innerHTML='<div class="muted">No hay transacciones</div>';
      else{
        const ul = document.createElement('div');
        recent.forEach(r=>{
          const d = document.createElement('div'); d.style.marginBottom='8px';
          if(r.items) d.innerHTML = `<div><strong>Venta</strong> ${money(r.total)} <span class="muted">(${r.paymentType})</span></div><div class="muted">${r.items.map(i=>i.name).join(', ')}</div>`;
          else d.innerHTML = `<div><strong>${r.type}</strong> ${money(r.amount)} <span class="muted">${r.payMethod}</span></div><div class="muted">${r.desc} ${r.note||''}</div>`;
          ul.appendChild(d);
        });
        rl.appendChild(ul);
      }

      // indicators for backup
      $('backup-interval-text').textContent = autoBackupInterval + 's';

      // status
      setStatus('Listo — cambios guardados: ' + (state.lastBackup? new Date(state.lastBackup).toLocaleString() : 'Nunca'));
    }

    function setStatus(txt){ $('status-text').textContent = txt; }

    // add item
    $('btn-add-item').addEventListener('click', ()=>{
      const name = $('item-name').value.trim();
      const qty = Number($('item-qty').value) || 1;
      const price = Number($('item-price').value) || 0;
      const note = $('item-note').value.trim();
      if(!name){ alert('Ingrese nombre del producto'); return; }
      let comanda = JSON.parse(sessionStorage.getItem('current_comanda')||'null') || {items:[]};
      comanda.items.push({name,qty,price,note});
      sessionStorage.setItem('current_comanda', JSON.stringify(comanda));
      $('item-name').value=''; $('item-note').value=''; $('item-price').value='0'; $('item-qty').value='1';
      render();
    });

    // close comanda / venta
    $('btn-add-comanda').addEventListener('click', ()=>{
      const comanda = JSON.parse(sessionStorage.getItem('current_comanda')||'null');
      if(!comanda || comanda.items.length===0){ alert('No hay items en la comanda'); return; }
      const paymentType = $('payment-type').value;
      const total = comanda.items.reduce((s,it)=>s + it.qty * it.price,0);
      const sale = {id:uid(), items:comanda.items, total, paymentType, date:new Date().toISOString()};
      state.sales.push(sale); saveState();
      sessionStorage.removeItem('current_comanda'); render();
    });

    // movement add
    $('btn-add-mov').addEventListener('click', ()=>{
      const type = $('mov-type').value;
      const payMethod = $('mov-paymethod').value;
      const desc = $('mov-desc').value.trim();
      const amount = Number($('mov-amount').value)||0;
      const note = $('mov-note').value.trim();
      if(!desc){ alert('Ingrese descripción'); return; }
      if(amount<=0){ alert('Monto debe ser mayor a 0'); return; }
      const mov = {id:uid(), type, desc, amount, payMethod, note, date:new Date().toISOString(), paid: type!=='Credito'};
      state.movements.push(mov); saveState(); render();
    });

    // mark credit as paid
    $('btn-mark-paid').addEventListener('click', ()=>{
      const credits = state.movements.filter(m=>m.type==='Credito' && !m.paid);
      if(credits.length===0){ alert('No hay créditos pendientes'); return; }
      // simple: mark the first pending as paid via selected paymethod & amount input
      const payMethod = $('mov-paymethod').value; const amount = Number($('mov-amount').value)||0;
      const mov = credits[0]; mov.paid = true; mov.payMethod = payMethod; mov.note = (mov.note||'') + ' | Pagado manualmente';
      saveState(); render();
    });

    // logic for export/import

    
    $('btn-export').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = `pos_backup_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      setStatus('Exportado respaldo');
    });
    $('btn-import').addEventListener('click', ()=> $('file-import').click());
    $('file-import').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return; const text = await f.text(); try{ state = JSON.parse(text); saveState(); render(); alert('Importado con éxito'); }catch(err){ alert('Error al importar: ' + err.message); }
    });

    // link file (File System Access API)
    $('btn-link-file').addEventListener('click', async ()=>{
      if(!window.showSaveFilePicker){ alert('API de archivos no soportada en este navegador. Use Chrome/Edge o use export/import manual.'); return; }
      try{
        fileHandle = await window.showSaveFilePicker({suggestedName:'pos_backup.json', types:[{description:'JSON', accept:{'application/json':['.json']}}]});
        await writeToLinkedFile();
        setStatus('Archivo vinculado para reescritura automática');
      }catch(e){ console.warn(e); setStatus('Cancelado vincular archivo'); }
    });

    // force backup
    $('btn-auto-backup').addEventListener('click', ()=>{ $('btn-export').click(); });

    // toggle auto backup
    $('btn-toggle-auto').addEventListener('click', ()=>{
      if(autoBackupTimer){ clearInterval(autoBackupTimer); autoBackupTimer = null; setStatus('Auto backup detenido'); $('btn-toggle-auto').textContent='Activar auto (60s)'; }
      else{
        autoBackupTimer = setInterval(()=>{ saveState(); console.log('Auto backup realizado'); }, autoBackupInterval*1000);
        setStatus('Auto backup activo cada ' + autoBackupInterval + 's'); $('btn-toggle-auto').textContent='Desactivar auto';
      }
    });

    // initialize
    loadState(); render();

    // save when closing
    window.addEventListener('beforeunload', ()=> saveState());
  </script>
</body>
</html>
